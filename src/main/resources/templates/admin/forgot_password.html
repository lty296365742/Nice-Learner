<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>INSPINIA | Forgot password</title>

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/font-awesome/css/font-awesome.css}" rel="stylesheet">
    <!-- 国内使用 -->
    <script type="text/javascript" charset="utf-8" src="//g.alicdn.com/sd/ncpc/nc.js?t=2015052012"></script>
    <link th:href="@{/css/animate.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <!-- Sweet Alert -->
    <link th:href="@{/css/plugins/sweetalert/sweetalert.css}" rel="stylesheet">

</head>

<body class="gray-bg">

    <div class="passwordBox animated fadeInDown">
        <div class="row">

            <div class="col-md-12">
                <div class="ibox-content">

                    <h2 class="font-bold" id="title">Forgot password</h2>

                    <p>
                        Enter your email address or phone and your password will be reset and emailed to you.
                    </p>

                    <div class="row">

                        <div class="col-lg-12">
                            <form class="m-t" role="form" id="one"  >
                                <div class="form-group">
                                    <input  type="text" id="account" class="form-control" placeholder="Email or Phone" required="">
                                </div>
                                <div class="form-group">
                                    <div id="your-dom-id"></div>
                                </div>
                                <button type="button" id="findPassword_btn" class="btn btn-primary block full-width m-b">Send new password</button>

                            </form>
                            <form class="m-t" role="form" id="two" style="display: none" >
                                <div class="form-group">
                                    <input type="text" id="password" class="form-control" placeholder="Password " required="">

                                </div>
                                <div class="form-group">
                                    <input type="text" id="password_2" class="form-control" placeholder="Password Again" required="">
                                    <br>
                                    <div class="alert alert-danger" id="tip" style="display: none" >
                                        两次密码输入不一致
                                    </div>
                                </div>
                                <button type="button" id="setNewPasswordBtn" class="btn btn-primary block full-width m-b">Set new password</button>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr/>
        <div class="row">
            <div class="col-md-6">
                Copyright Example Company
            </div>
            <div class="col-md-6 text-right">
               <small>© 2014-2015</small>
            </div>
        </div>
    </div>
    <script th:src="@{/js/jquery-2.1.1.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/plugins/metisMenu/jquery.metisMenu.js}"></script>
    <script th:src="@{/js/plugins/slimscroll/jquery.slimscroll.min.js}"></script>
    <!-- Sweet alert -->
    <script th:src="@{/js/plugins/sweetalert/sweetalert.min.js}"></script>
    <script type="text/javascript">
        var csessionid;
        var sig;
        var scene="sc_register";
        var code;
        var nc_token = ["FFFF0N00000000005BE9", (new Date()).getTime(), Math.random()].join(':');
        var NC_Opt = {
            renderTo: "#your-dom-id",
            appkey: "FFFF0N00000000005BE9",
            scene: 'sc_register',
            token: nc_token,
            trans: {'key1': "code0"},
            is_Opt: 0,
            type: "scrape",
            width: 300,
            height: 100,
            isEnabled: true,
            language: 'cn',
            times: 5,
            objects: ["//img.alicdn.com/tps/TB1BT9jPFXXXXbyXFXXXXXXXXXX-80-80.png"],//勿动，照抄即可
            apimap: {
                // 'uab_Url': '//aeu.alicdn.com/js/uac/909.js',
            },
            elements: [
                '//img.alicdn.com/tfs/TB17cwllsLJ8KJjy0FnXXcFDpXa-50-74.png',
                '//img.alicdn.com/tfs/TB17cwllsLJ8KJjy0FnXXcFDpXa-50-74.png'
            ],
            bg_back_prepared: '//img.alicdn.com/tps/TB1skE5SFXXXXb3XXXXXXXXXXXX-100-80.png',
            bg_front: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABQCAMAAADY1yDdAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAADUExURefk5w+ruswAAAAfSURBVFjD7cExAQAAAMKg9U9tCU+gAAAAAAAAAIC3AR+QAAFPlUGoAAAAAElFTkSuQmCC',
            obj_ok: '//img.alicdn.com/tfs/TB1rmyTltfJ8KJjy0FeXXXKEXXa-50-74.png',
            bg_back_pass: '//img.alicdn.com/tfs/TB1KDxCSVXXXXasXFXXXXXXXXXX-100-80.png',
            obj_error: '//img.alicdn.com/tfs/TB1q9yTltfJ8KJjy0FeXXXKEXXa-50-74.png',
            bg_back_fail: '//img.alicdn.com/tfs/TB1w2oOSFXXXXb4XpXXXXXXXXXX-100-80.png',
            upLang:{"cn":{
                    _ggk_guide: "请摁住鼠标左键，刮出两面盾牌",
                    _ggk_success: "恭喜您成功刮出盾牌<br/>继续下一步操作吧",
                    _ggk_loading: "加载中",
                    _ggk_fail: ['呀，盾牌不见了<br/>请', "javascript:noCaptcha.reset()", '再来一次', '或', "http://survey.taobao.com/survey/QgzQDdDd?token=%TOKEN", '反馈问题'],
                    _ggk_action_timeout: ['我等得太久啦<br/>请', "javascript:noCaptcha.reset()", '再来一次', '或', "http://survey.taobao.com/survey/QgzQDdDd?token=%TOKEN", '反馈问题'],
                    _ggk_net_err: ['网络实在不给力<br/>请', "javascript:noCaptcha.reset()", '再来一次', '或', "http://survey.taobao.com/survey/QgzQDdDd?token=%TOKEN", '反馈问题'],
                    _ggk_too_fast: ['您刮得太快啦<br/>请', "javascript:noCaptcha.reset()", '再来一次', '或', "http://survey.taobao.com/survey/QgzQDdDd?token=%TOKEN", '反馈问题']
                }
            },
            callback: function(data) { //成功回调
                window.console && console.log(nc_token);
                window.console && console.log(data.sessionId);
                csessionid=data.sessionId;
                window.console && console.log(data.sig);
                sig=data.sig;
            },
            failCallback: function(data) { //拦截or失败回调
            },
            error: function(data) { //异常回调
            }
        };
        var nc = new noCaptcha(NC_Opt);
        $(function(){
            $("#findPassword_btn").click(function(){
                doFindPassword();
            });
            $("#setNewPasswordBtn").click(function () {
                doSetPassword();
            })
        });


        function doFindPassword() {
            var countdown=120;
            settime();
            swal({
                    title: "请输入您收到的验证码",
                    text: "倒计时2分钟,验证码有略微延迟，请耐心等候",
                    type: "input",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    animation: "slide-from-top",
                    inputPlaceholder: "验证码"
                },
                function(inputValue){
                    if (inputValue === false) return false;

                    if (inputValue === ""||inputValue===null) {
                        swal.showInputError("你需要输入一些话！");
                        return false
                    }


                    if (inputValue===code){
                        swal("非常好！", "验证成功,点击确定按钮设置您的新密码","success");
                        window.document.getElementById("one").style.display="none";
                        window.document.getElementById("two").style.display="block";
                    }else {
                        swal({
                            title: "验证错误！",
                            text: "2秒后自动关闭,并刷新页面，请重新操作",
                            timer: 2000,
                            showConfirmButton: false
                        });
                        setTimeout(function() {
                            window.location.reload();//刷新页面
                        },2000);
                    }

                });
            $.ajax({
                type:"GET",
                url:"/learner.me/api/users/password",
                dataType:"text",
                data:{account:$("#account").val(),
                    sessionId:csessionid,
                    sig:sig,
                    Token:nc_token,
                    scene:scene
                },
                success:function (r) {
                    var data=JSON.parse(r);
                    console.log(data);
                    if (data.code == 0) {
                        code=data.data.plainPassword;
                        console.log(code);

                    } else {
                        swal("错误信息！", "您的信息校验不正确！","error");
                    }
                }
            });
            function settime() {
                if (countdown == 0) {
                    swal({
                        title: "超时错误！",
                        text: "2秒后自动关闭,并刷新页面，请重新操作",
                        timer: 2000,
                        showConfirmButton: false
                    });
                    setTimeout(function() {
                        window.location.reload();//刷新页面
                    },2000);

                    return;
                } else {
                    countdown--;
                }
                setTimeout(function() {
                    settime()
                },1000);
            }
        }
        function doSetPassword() {
            var onePwd=window.document.getElementById("password").value;
            var twoPwd=window.document.getElementById("password_2").value;
            window.document.getElementById("title").value="Set New Password";
            if (onePwd===twoPwd){
                $.ajax({
                    type:"post",
                    url:"/learner.me/api/users/password",
                    dataType:"text",
                    data:{password:$("#password").val()
                    },
                    success:function (r) {
                        var data=JSON.parse(r);
                        console.log(data);
                        if (data.code == 0) {
                            swal({
                                title: "设置成功",
                                text: "快去登陆吧",
                                type: "success",
                                showCancelButton: true,
                                confirmButtonColor: "#DD6B55",
                                confirmButtonText: "登陆",
                                closeOnConfirm: false
                            }, function () {
                                window.document.getElementById("tip").style.display="none";
                                window.location.href = "http://localhost:1000/learner.me/admin/login";
                            });

                        } else {
                            swal("出现异常！", "请尝试重新设置密码！","error");
                        }
                    }
                });

            }else {
                window.document.getElementById("tip").style.display="block";
            }
        }
    </script>
</body>

</html>
